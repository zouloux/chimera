
server
{
    # Capture all sub-domains as service and inject service name as header
    server_name ~^(?<service>.+){{DOMAIN_NAME}}$;
    add_header X-service "$service";

    #access_log "/var/log/nginx/$service-access.log";
    access_log off;
    error_log  "/var/log/nginx/$service-error.log";

    # Redirect all queries
    location /
    {
        # Use docker resolver so $services becomes container IP
        resolver 127.0.0.11 ipv6=off;

        # Force to get service from .chimera network to avoid being a huge proxy for everyone
        set $target http://$service.chimera:80;

        # Proxy to this target
        proxy_pass $target;
    }
}